<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bámbula Studio LLC — Book</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
</head>
<body class="book-page" data-flow="inquiry">
  <header class="site-header">
    <div class="container" style="padding:8px 20px">
      <div class="brand">
        <img src="assets/bambula_primarylogo.png" alt="Bámbula Studio logo" class="logo logo--blend">
        <!-- <span class="wordmark">Bámbula Studio</span> -->
      </div>
      <nav class="nav">
        <a href="index.html#classes" class="btn btn--small" data-i18n="book.back">Back to Classes</a>
      </nav>
      <button id="langToggle" class="lang" aria-label="Toggle language">ES</button>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <h1 data-i18n="book.title">Book Your Session</h1>
      <p><strong data-i18n="book.selected">Selected</strong>: <span id="selLevel" data-i18n="classes.group.basic">Basic</span> — <span id="selPlan" data-i18n="pricing.basic.monthly.title">4-Class Pack</span></p>

      <div class="grid" style="margin-top:1rem">
        <div class="card" id="payCard">
          <h2 data-i18n="book.step1">Step 1: Pay</h2>
          <p class="note">
            <span class="info-pill" data-i18n="billing.onetime">One-time payment</span>
            <div class="note-line" data-i18n="billing.note.onetime">No auto-renewals.</div>
          </p>
          <div id="paypalButtons" style="display:none;margin-bottom:.75rem"></div>
          <a id="payLink" href="#" class="btn" target="_blank" rel="noopener" data-i18n="book.pay">Pay Now</a>
          <p id="payNote" class="note" data-i18n="book.noLink" style="display:none">Payment link not configured yet.</p>
          <div id="payResult" class="note" style="display:none"></div>
        </div>

        <div class="card" id="scheduleCard">
          <h2 id="scheduleHeading" data-i18n="book.step2">Step 2: Schedule</h2>
          <div class="form" style="margin:0 0 12px 0">
            <label>
              <span>Name</span>
              <input id="prefillName" type="text" placeholder="Your name" autocomplete="name" />
            </label>
            <label>
              <span>Email</span>
              <input id="prefillEmail" type="email" placeholder="you@example.com" autocomplete="email" />
            </label>
            <button id="applyPrefill" class="btn btn--small" type="button">Apply to calendar</button>
          </div>
          <p class="note" id="pendingNote1">Note: Your time selection is a request and is pending approval. After payment, we will confirm or offer alternatives if needed.</p>
          <!-- Provider embed goes here -->
          <div id="schedulerEmbed" style="min-height:420px"></div>
          <p id="schedNote" class="note" data-i18n="book.noScheduler" style="display:none">Scheduler not embedded yet.</p>
        </div>
      </div>
    </div>
  </main>

  <script>
  // <script>
  // Parse query params
  function qp(k){ return new URLSearchParams(location.search).get(k); }
  const category = ['dance','percussion'].includes(qp('category')) ? qp('category') : 'percussion';
  const level    = ['basic','intermediate','advanced'].includes(qp('level')) ? qp('level') : 'basic';
  const plan     = ['single','monthly','full'].includes(qp('plan')) ? qp('plan') : 'monthly';
  const flow     = (document.body.getAttribute('data-flow')||'inquiry').toLowerCase();

  // Category-aware payment links
  window.bookingPaymentLinks = {
    percussion: {
      basic:        { single:'https://square.link/u/YLMAxgnC', monthly:'https://square.link/u/FXzWjQRB', full:'https://square.link/u/Ph7UoF4E' },
      intermediate: { single:'#', monthly:'#',                                 full:'#' },
      advanced:     { single:'#', monthly:'#',                                 full:'#' },
    },
    dance: {
      basic:        { single:'#', monthly:'#',                                  full:'https://square.link/u/PmRFDljM' },
      intermediate: { single:'#', monthly:'#',                                  full:'#' },
      advanced:     { single:'#', monthly:'#',                                  full:'#' },
    }
  };

  // (Optional) label
  document.getElementById('payLink').textContent = 'Pay with Square';

  // Category-aware scheduler links (you can duplicate percussion for now)
  window.bookingSchedulerLinks = {
    percussion: {
      basic:        { single:'https://cal.com/bambulastudio/basic-single',        monthly:'https://cal.com/bambulastudio/basic-4pack',        full:'https://cal.com/bambulastudio/basic-complete' },
      intermediate: { single:'https://cal.com/bambulastudio/intermediate-single', monthly:'https://cal.com/bambulastudio/intermediate-4pack', full:'https://cal.com/bambulastudio/intermediate-complete' },
      advanced:     { single:'https://cal.com/bambulastudio/advanced-single',     monthly:'https://cal.com/bambulastudio/advanced-4pack',     full:'https://cal.com/bambulastudio/advanced-complete' }
    },
    dance: {
      basic:        { single:'https://cal.com/bambulastudio/dance-basic-single',  monthly:'https://cal.com/bambulastudio/dance-basic-4pack',  full:'https://cal.com/bambulastudio/dance-basic-complete' },
      intermediate: { single:'#', monthly:'#', full:'#' },
      advanced:     { single:'#', monthly:'#', full:'#' }
    }
  };
    // Payments pause switch: set to true to temporarily disable live PayPal buttons
    // (e.g., while PayPal removes an account restriction). When true, users will
    // see the fallback note/link instead of the button. Set to false to re-enable.
    window.paymentsPaused = true;

    // // Parse query params ?level=basic&plan=monthly
    // function qp(k){ return new URLSearchParams(location.search).get(k); }
    // const level = ['basic','intermediate','advanced'].includes(qp('level')) ? qp('level') : 'basic';
    // const plan = ['single','monthly','full'].includes(qp('plan')) ? qp('plan') : 'monthly';
    // const flow = (document.body.getAttribute('data-flow')||'inquiry').toLowerCase(); // 'pay' or 'inquiry'


    // // Configure your payment links (Stripe Payment Links or provider checkout)
    // // and scheduler links (Calendly/Cal.com event URLs) here.
    // window.bookingPaymentLinks = {
    //   basic: { 
    //     single: '#',
    //     monthly: 'https://square.link/u/FXzWjQRB',  // ← your Square link
    //     full: 'https://square.link/u/Ph7UoF4E'      // ← your Square link
    //   },
    //   intermediate: { 
    //     single: '#',
    //     monthly: '#',  
    //     full: '#'
    //   },
    //   advanced: { 
    //     single: '#',
    //     monthly: '#',  
    //     full: '#'
    //   },
    // };

    // window.bookingSchedulerLinks = {
    //   basic: { single: 'https://cal.com/bambulastudio/basic-single', monthly: 'https://cal.com/bambulastudio/basic-4pack', full: 'https://cal.com/bambulastudio/basic-complete' },
    //   intermediate: { single: 'https://cal.com/bambulastudio/intermediate-single', monthly: 'https://cal.com/bambulastudio/intermediate-4pack', full: 'https://cal.com/bambulastudio/intermediate-complete' },
    //   advanced: { single: 'https://cal.com/bambulastudio/advanced-single', monthly: 'https://cal.com/bambulastudio/advanced-4pack', full: 'https://cal.com/bambulastudio/advanced-complete' }
    // };

    // Optional: PayPal Smart Buttons (client-side) — quick starter
    // Set your PayPal REST client-id to enable buttons; leave empty to use links above
    // Sandbox test client-id (replace with your Live client-id when going live):
    // window.paypalClientId = 'AZxl5FLsrIryvjAMaShccHNz59v6r4DBJ92aSkN_I-qLGbxh8zCKnphcJCSUom2ZWVk9NS2hDTWNkGrx'; // SANDBOX
    // Live client-id:
    // window.paypalClientId = 'Aa4zMg60V-3S2yNxhMWqWhkx1fXhSt8oVPgNHxixM6WM22ONoA76vCNJA2ctMmU3rWq5vdIsJ8snUEYr'; // LIVE
    // Amounts used when PayPal buttons are enabled (USD)
    window.bookingPrices = {
      currency: 'USD',
      basic: { single: 1, monthly: 1, full: 1 },
      intermediate: { single: 1, monthly: 1, full: 1 },
      advanced: { single: 1, monthly: 1, full: 1 }
      // basic: { single: 120, monthly: 439, full: 1599 },
      // intermediate: { single: 125, monthly: 459, full: 1679 },
      // advanced: { single: 130, monthly: 479, full: 1759 }
    };
    // End configuration

    // Defer i18n mapping of labels to script.js by changing data-i18n keys dynamically
    function setI18nKey(el, key){ if (el) el.setAttribute('data-i18n', key); }
  // - const levelKey = `classes.group.${level}`;
    const levelKey = (category==='dance')
    ? `dance.group.${level}`
    : `classes.group.${level}`;
    setI18nKey(document.getElementById('selLevel'), levelKey);
    const planKeyMap = { single: 'pricing.basic.title', monthly: 'pricing.basic.monthly.title', full: 'pricing.basic.full.title' };
    const planKey = planKeyMap[plan];
    setI18nKey(document.getElementById('selLevel'), levelKey);
    setI18nKey(document.getElementById('selPlan'), planKey);

    // If inquiry flow, adjust steps: 1) Schedule/Request with gate, 2) Payment with both options (Pay Now + Payment Link)
    (function(){
      if (flow === 'inquiry'){
        // Update schedule heading to Step 1 and prevent i18n overwrite
        const schedH = document.getElementById('scheduleHeading');
        if (schedH){ schedH.removeAttribute('data-i18n'); schedH.textContent = 'Step 1: Choose a preferred time or request'; }

        // Build a unified Step 2 Payment card with two options side-by-side
        const grid = document.querySelector('.grid');
        const scheduleCard = document.getElementById('scheduleCard');
        if (grid && scheduleCard){
          const paymentCard = document.createElement('div');
          paymentCard.className = 'card';
          paymentCard.id = 'paymentCard';
          paymentCard.style.display = 'none';
          paymentCard.innerHTML = [
            '<h2 id="paymentHeading">Step 2: Payment</h2>',
            '<div class="pay-grid pay-grid--single">',
            '  <div class="pay-option-now">',
            '    <h3 style="margin-top:0">Pay Now</h3>',
            '    <div id="payNowMount"></div>',
            '  </div>',
            '</div>',
            // '<p class="note" id="pendingNote2">After payment, we\'ll approve your requested time and send a confirmation email. If the slot isn\'t available, we\'ll coordinate alternatives.</p>'
          ].join('');
          grid.insertBefore(paymentCard, scheduleCard.nextSibling);

          // Move existing pay controls into the Pay Now slot
          const mount = paymentCard.querySelector('#payNowMount');
          const btns = document.getElementById('paypalButtons');
          const link = document.getElementById('payLink');
          const note = document.getElementById('payNote');
          const result = document.getElementById('payResult');
          [btns, link, note, result].forEach(el => { if (el && mount) mount.appendChild(el); });

          // Remove the original pay card (if present) to avoid duplicate headings/grid
          const oldPayCard = document.getElementById('payCard');
          if (oldPayCard && oldPayCard !== paymentCard){ oldPayCard.remove(); }
        }
      }
    })();

    // Wire Pay (PayPal buttons if clientId present; otherwise fallback to link)
    (function(){
      // - const payLink = (window.bookingPaymentLinks[level]||{})[plan];
      const payLink = (window.bookingPaymentLinks[category]?.[level] || {})[plan];      
      const a = document.getElementById('payLink');
      const note = document.getElementById('payNote');
      const btnsWrap = document.getElementById('paypalButtons');

      const qs = new URLSearchParams(location.search);
      let cid = (window.paypalClientId||'').trim();
      const prices = window.bookingPrices || {};
      const currency = prices.currency || 'USD';
      let amount = prices[level] && prices[level][plan];
      // Optional: URL override for quick live tests (?amt=10). For live,
      // avoid micro-charges that can trigger account review; enforce a minimum.
      const amtOverride = Number(qs.get('amt'));
      if (!Number.isNaN(amtOverride) && amtOverride >= 5) amount = amtOverride;
      // Note: for Sandbox tests, swap to your Sandbox Client ID. Do not use legacy pp_test flags.

      function renderButtons(){
        // If payments are paused, show fallback and do not load SDK
        if (window.paymentsPaused){
          btnsWrap.style.display = 'none';
          a.style.display = 'inline-block';
          note.textContent = 'Payments are temporarily offline. We will email you a secure payment link to complete your booking.';
          note.style.display = '';
          return false;
        }
        // Validate inputs before loading SDK
        if (!cid) return false;
        if (typeof amount !== 'number' || isNaN(amount) || amount <= 0){
          // Fallback to link if amount invalid
          btnsWrap.style.display = 'none';
          a.style.display = 'inline-block';
          note.style.display = '';
          return false;
        }
        const id = 'paypal-sdk';
        function setupButtons(){
          if (!window.paypal || !window.paypal.Buttons){
            // If SDK failed to load, show link fallback
            btnsWrap.style.display = 'none';
            a.style.display = 'inline-block';
            note.style.display = '';
            return;
          }
          btnsWrap.style.display = 'block';
          a.style.display = 'none';
          note.style.display = 'none';
          btnsWrap.innerHTML = '';
          const resultEl = document.getElementById('payResult');
          const buttons = window.paypal.Buttons({
            style: { layout: 'horizontal', color: 'black', shape: 'rect', label: 'pay', height: 45 },
            createOrder: function(data, actions){
              return actions.order.create({
                purchase_units: [{ amount: { currency_code: currency, value: amount.toFixed(2) }, description: level + ' / ' + plan }]
              });
            },
            onApprove: function(data, actions){
              return actions.order.capture().then(function(details){
                // Show simple confirmation with order ID and payer name if available
                try {
                  const payer = details.payer && (details.payer.name?.given_name || details.payer.name?.surname) ?
                    (details.payer.name.given_name + ' ' + (details.payer.name.surname||'')).trim() : '';
                  const orderId = details.id || data.orderID || '';
                  // Build a cleaner receipt with exact selection labels
                  const selLevelEl = document.getElementById('selLevel');
                  const selPlanEl = document.getElementById('selPlan');
                  const selText = `${(selLevelEl?.textContent||level)} — ${(selPlanEl?.textContent||plan)}`;
                  const payerEmail = (details.payer && details.payer.email_address) ? details.payer.email_address : '';
                  const subject = `Receipt - Order ${orderId}`;
                  const body = [
                    'Thank you for your purchase.',
                    `Selected: ${selText}`,
                    `Order ID: ${orderId}`,
                    `Amount Paid: ${currency} ${Number(amount).toFixed(2)}`,
                    '',
                    'If you need any updates, just reply to this email.'
                  ].join('\n');
                  const mailto = `mailto:${payerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                  const html = [
                    '<div class="receipt">',
                    '  <div class="receipt-title">Thank you for your purchase!'+(payer? ' — '+payer : '')+'</div>',
                    '  <div><strong>Selected:</strong> '+ selText +'</div>',
                    '  <div><strong>Order ID:</strong> '+ orderId +'</div>',
                    '  <div><strong>Amount Paid:</strong> '+ (currency || '') + ' ' + Number(amount).toFixed(2) +'</div>',
                    '  <div class="receipt-meta">We will review your requested time and email confirmation shortly.</div>',
                    '  <div class="receipt-actions" style="margin-top:8px; display:flex; gap:.5rem;">',
                    '    <a class="btn btn--small" href="'+mailto+'">Email Receipt</a>',
                    '    <button class="btn btn--small" type="button" onclick="window.print()">Print</button>',
                    '  </div>',
                    '</div>'
                  ].join('');
                  if (resultEl){ resultEl.innerHTML = html; resultEl.style.display = 'block'; }
                  // Clean the Pay area for a modern receipt view
                  try{
                    var pb = document.getElementById('paypalButtons'); if (pb) pb.style.display = 'none';
                    var linkEl = document.getElementById('payLink'); if (linkEl) linkEl.style.display = 'none';
                    var heading = document.getElementById('paymentHeading'); if (heading) heading.textContent = 'Payment Received';
                    var payNowTitle = document.querySelector('.pay-option-now h3'); if (payNowTitle) payNowTitle.style.display = 'none';
                  } catch(_){}
                  // Broadcast payer info so the scheduler can prefill fields
                  const email = details.payer && details.payer.email_address ? details.payer.email_address : '';
                  const evt = new CustomEvent('payment:approved', { detail: { name: payer, email } });
                  window.dispatchEvent(evt);
                } catch(_){}
                // After capture, scroll to Step 2
                document.getElementById('schedulerEmbed')?.scrollIntoView({behavior:'smooth', block:'start'});
              });
            },
            onError: function(err){
              if (resultEl){
                const msg = (err && err.message) ? String(err.message) : 'There was an error with PayPal. Please try again.';
                resultEl.textContent = msg;
                resultEl.style.display = 'block';
              }
              // Fall back to link if buttons error out
              btnsWrap.style.display = 'none';
              a.style.display = 'inline-block';
              note.style.display = '';
            },
            onCancel: function(){
              if (resultEl){ resultEl.textContent = 'Payment cancelled before completion.'; resultEl.style.display = 'block'; }
            }
          });
          try {
            const r = buttons.render('#paypalButtons');
            if (r && typeof r.catch === 'function'){
              r.catch(()=>{
                btnsWrap.style.display = 'none';
                a.style.display = 'inline-block';
                note.style.display = '';
              });
            }
          } catch (e){
            btnsWrap.style.display = 'none';
            a.style.display = 'inline-block';
            note.style.display = '';
          }
        }
        if (!document.getElementById(id)){
          const s = document.createElement('script');
          s.id = id;
          s.src = 'https://www.paypal.com/sdk/js?components=buttons&client-id=' + encodeURIComponent(cid) + '&currency=' + encodeURIComponent(currency);
          s.onload = setupButtons;
          document.head.appendChild(s);
        } else {
          setupButtons();
        }
        return true;
      }

      if (!renderButtons()){
        if (payLink && payLink !== '#'){ a.href = payLink; note.style.display = 'none'; }
        else { a.href = '#'; note.style.display = 'block'; }
      }
    })();

    // Wire scheduler: supports Calendly (script embed) and generic iframe links.
    (function(){
      const qs = new URLSearchParams(location.search);
      const override = qs.get('sched');
    // - let baseUrl = override || ((window.bookingSchedulerLinks[level]||{})[plan]);
      let baseUrl = override || ((window.bookingSchedulerLinks[category]?.[level] || {})[plan]);
      const wrap = document.getElementById('schedulerEmbed');
      const note = document.getElementById('schedNote');
      const nameInput = document.getElementById('prefillName');
      const emailInput = document.getElementById('prefillEmail');
      const applyBtn = document.getElementById('applyPrefill');

      function ensureCalendlyScript(){
        if (document.getElementById('calendly-widget-js')) return;
        const s = document.createElement('script');
        s.id = 'calendly-widget-js';
        s.src = 'https://assets.calendly.com/assets/external/widget.js';
        s.async = true;
        document.head.appendChild(s);
      }

      function buildUrl(u){
        if (!u) return u;
        try{
          const url = new URL(u, location.origin);
          const name = (nameInput && nameInput.value || '').trim();
          const email = (emailInput && emailInput.value || '').trim();
          if (/cal\.com/i.test(url.hostname)){
            // Cal.com supports embed=true and basic prefill for name/email
            url.searchParams.set('embed', 'true');
            if (name) url.searchParams.set('name', name);
            if (email) url.searchParams.set('email', email);
          } else if (/calendly\.com/i.test(url.hostname)){
            if (name) url.searchParams.set('name', name);
            if (email) url.searchParams.set('email', email);
          }
          return url.toString();
        } catch { return u; }
      }

      function setCalendly(u){
        const finalUrl = buildUrl(u);
        wrap.innerHTML = '<div class="calendly-inline-widget" data-url="'+finalUrl.replace(/&/g,'&amp;')+'" style="min-width:320px;height:700px;"></div>';
        ensureCalendlyScript();
      }

      function setIframe(u){
        const finalUrl = buildUrl(u);
        const i = document.createElement('iframe');
        i.title = 'Scheduler';
        i.style.cssText = 'width:100%;height:700px;border:0;border-radius:8px;background:#fff';
        i.src = finalUrl;
        wrap.innerHTML = '';
        wrap.appendChild(i);
      }

      function readyForCalendar(){
        const name = (nameInput && nameInput.value || '').trim();
        const email = (emailInput && emailInput.value || '').trim();
        const okEmail = /.+@.+\..+/.test(email);
        return name.length > 1 && okEmail;
      }

      function render(){
        // Gate calendar until name/email are provided (both flows)
        if (!readyForCalendar()){
          wrap.innerHTML = '';
          note.textContent = 'Enter your name and email, then click "Apply to calendar".';
          note.style.display = 'block';
          // simple inline validation styles
          const nameVal = (nameInput && nameInput.value || '').trim();
          const emailVal = (emailInput && emailInput.value || '').trim();
          const okEmail = /.+@.+\..+/.test(emailVal);
          if (nameInput){ nameInput.classList.toggle('invalid', nameVal.length <= 1); }
          if (emailInput){ emailInput.classList.toggle('invalid', !okEmail); }
          // Hide payment card until valid contact info is provided
          const payCard = document.getElementById('paymentCard');
          if (payCard) payCard.style.display = 'none';
          return;
        }
        // clear validation
        if (nameInput) nameInput.classList.remove('invalid');
        if (emailInput) emailInput.classList.remove('invalid');
        // Reveal payment card once we have valid contact info
        const payCard = document.getElementById('paymentCard');
        if (payCard) payCard.style.display = '';
        const url = baseUrl;
        if (url && url !== '#'){
          note.style.display = 'none';
          if (/calendly\.com/i.test(url)) setCalendly(url);
          else if (/cal\.com/i.test(url)) setIframe(url);
          else setIframe(url);
        } else {
          wrap.innerHTML = '';
          note.style.display = 'block';
        }
      }

      // Initial: don’t render until user applies (gated)
      render();

      // Apply prefill to show calendar and hide form once valid
      if (applyBtn) applyBtn.addEventListener('click', ()=>{
        render();
        if (readyForCalendar()){
          const formWrap = document.querySelector('#scheduleCard .form');
          if (formWrap) formWrap.style.display = 'none';
        }
      });

      // When payment is approved, prefill fields (if empty) and render calendar
      window.addEventListener('payment:approved', (e)=>{
        try{
          const d = e.detail || {};
          if (nameInput && !nameInput.value && d.name) nameInput.value = d.name;
          if (emailInput && !emailInput.value && d.email) emailInput.value = d.email;
          render();
          const formWrap = document.querySelector('#scheduleCard .form');
          if (readyForCalendar() && formWrap) formWrap.style.display = 'none';
          document.getElementById('scheduleCard')?.scrollIntoView({behavior:'smooth', block:'start'});
        } catch(_){}
      });
    })();
  </script>
  <script src="script.js"></script>
</body>
</html>
