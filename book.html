<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bámbula Studio LLC — Book</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
</head>
<body class="book-page" data-flow="inquiry">
  <header class="site-header">
    <div class="container" style="padding:8px 20px">
      <div class="brand">
        <img src="assets/bambula_primarylogo.png" alt="Bámbula Studio logo" class="logo logo--blend">
        <!-- <span class="wordmark">Bámbula Studio</span> -->
      </div>
      <nav class="nav">
        <a href="new_index.html#classes" class="btn btn--small" data-i18n="book.back">Back to Classes</a>
      </nav>
      <button id="langToggle" class="lang" aria-label="Toggle language">ES</button>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <h1 data-i18n="book.title">Book Your Session</h1>
      <p><strong data-i18n="book.selected">Selected</strong>: <span id="selLevel" data-i18n="classes.group.basic">Basic</span> — <span id="selPlan" data-i18n="pricing.basic.monthly.title">4-Class Pack</span></p>

      <div class="grid" style="margin-top:1rem">
        <div class="card" id="payCard">
          <h2 data-i18n="book.step1">Step 1: Pay</h2>
          <p class="note">
            <span class="info-pill" data-i18n="billing.onetime">One-time payment</span>
            <div class="note-line" data-i18n="billing.note.onetime">No auto-renewals.</div>
          </p>
          <div id="paypalButtons" style="display:none;margin-bottom:.75rem"></div>
          <a id="payLink" href="#" class="btn" target="_blank" rel="noopener" data-i18n="book.pay">Pay Now</a>
          <p id="payNote" class="note" data-i18n="book.noLink" style="display:none">Payment link not configured yet.</p>
          <div id="payResult" class="note" style="display:none"></div>
        </div>

        <div class="card" id="scheduleCard">
          <h2 id="scheduleHeading" data-i18n="book.step2">Step 2: Schedule</h2>
          <div class="form" style="margin:0 0 12px 0">
            <label>
              <span>Name</span>
              <input id="prefillName" type="text" placeholder="Your name" autocomplete="name" />
            </label>
            <label>
              <span>Email</span>
              <input id="prefillEmail" type="email" placeholder="you@example.com" autocomplete="email" />
            </label>
            <button id="applyPrefill" class="btn btn--small" type="button">Apply to calendar</button>
          </div>
          <p class="note" id="pendingNote1">Note: Your time selection is a request and is pending approval. After payment, we will confirm or offer alternatives if needed.</p>
          <!-- Provider embed goes here -->
          <div id="schedulerEmbed" style="min-height:420px"></div>
          <p id="schedNote" class="note" data-i18n="book.noScheduler" style="display:none">Scheduler not embedded yet.</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Configure your payment links (Stripe Payment Links or provider checkout)
    // and scheduler links (Calendly/Cal.com event URLs) here.
    // Example placeholders — replace '#' with real links.
    window.bookingPaymentLinks = {
      basic: { single: '#', monthly: '#', full: '#' },
      intermediate: { single: '#', monthly: '#', full: '#' },
      advanced: { single: '#', monthly: '#', full: '#' }
    };
    window.bookingSchedulerLinks = {
      basic: { single: 'https://cal.com/bambulastudio/basic-single', monthly: 'https://cal.com/bambulastudio/basic-4pack', full: 'https://cal.com/bambulastudio/basic-complete' },
      intermediate: { single: 'https://cal.com/bambulastudio/intermediate-single', monthly: 'https://cal.com/bambulastudio/intermediate-4pack', full: 'https://cal.com/bambulastudio/intermediate-complete' },
      advanced: { single: 'https://cal.com/bambulastudio/advanced-single', monthly: 'https://cal.com/bambulastudio/advanced-4pack', full: 'https://cal.com/bambulastudio/advanced-complete' }
    };

    // Optional: PayPal Smart Buttons (client-side) — quick starter
    // Set your PayPal REST client-id to enable buttons; leave empty to use links above
    // Sandbox test client-id (replace with your Live client-id when going live):
    window.paypalClientId = 'AZxl5FLsrIryvjAMaShccHNz59v6r4DBJ92aSkN_I-qLGbxh8zCKnphcJCSUom2ZWVk9NS2hDTWNkGrx';
    // Amounts used when PayPal buttons are enabled (USD)
    window.bookingPrices = {
      currency: 'USD',
      basic: { single: 120, monthly: 439, full: 1599 },
      intermediate: { single: 125, monthly: 459, full: 1679 },
      advanced: { single: 130, monthly: 479, full: 1759 }
    };

    // Parse query params ?level=basic&plan=monthly
    function qp(k){ return new URLSearchParams(location.search).get(k); }
    const level = ['basic','intermediate','advanced'].includes(qp('level')) ? qp('level') : 'basic';
    const plan = ['single','monthly','full'].includes(qp('plan')) ? qp('plan') : 'monthly';
    const flow = (document.body.getAttribute('data-flow')||'inquiry').toLowerCase(); // 'pay' or 'inquiry'

    // Defer i18n mapping of labels to script.js by changing data-i18n keys dynamically
    function setI18nKey(el, key){ if (el) el.setAttribute('data-i18n', key); }
    const levelKey = `classes.group.${level}`;
    const planKeyMap = { single: 'pricing.basic.title', monthly: 'pricing.basic.monthly.title', full: 'pricing.basic.full.title' };
    const planKey = planKeyMap[plan];
    setI18nKey(document.getElementById('selLevel'), levelKey);
    setI18nKey(document.getElementById('selPlan'), planKey);

    // If inquiry flow, adjust steps: 1) Schedule/Request with gate, 2) Payment with both options (Pay Now + Payment Link)
    (function(){
      if (flow === 'inquiry'){
        // Update schedule heading to Step 1 and prevent i18n overwrite
        const schedH = document.getElementById('scheduleHeading');
        if (schedH){ schedH.removeAttribute('data-i18n'); schedH.textContent = 'Step 1: Choose a preferred time or request'; }

        // Build a unified Step 2 Payment card with two options side-by-side
        const grid = document.querySelector('.grid');
        const scheduleCard = document.getElementById('scheduleCard');
        if (grid && scheduleCard){
          const paymentCard = document.createElement('div');
          paymentCard.className = 'card';
          paymentCard.innerHTML = [
            '<h2>Step 2: Payment</h2>',
            '<div class="pay-grid">',
            '  <div class="pay-option-now">',
            '    <h3 style="margin-top:0">Pay Now</h3>',
            '    <div id="payNowMount"></div>',
            '  </div>',
            '  <div class="pay-option-link">',
            '    <h3 style="margin-top:0">Get Payment Link by Email</h3>',
            '    <p class="note">After you request a time, we\'ll email you a secure payment link (PayPal). Paying via the link also requests your booking.</p>',
            '  </div>',
            '</div>',
            '<p class="note" id="pendingNote2">After payment, we\'ll approve your requested time and send a confirmation email. If the slot isn\'t available, we\'ll coordinate alternatives.</p>'
          ].join('');
          grid.insertBefore(paymentCard, scheduleCard.nextSibling);

          // Move existing pay controls into the Pay Now slot
          const mount = paymentCard.querySelector('#payNowMount');
          const btns = document.getElementById('paypalButtons');
          const link = document.getElementById('payLink');
          const note = document.getElementById('payNote');
          const result = document.getElementById('payResult');
          [btns, link, note, result].forEach(el => { if (el && mount) mount.appendChild(el); });

          // Remove the original pay card (if present) to avoid duplicate headings/grid
          const oldPayCard = document.getElementById('payCard');
          if (oldPayCard && oldPayCard !== paymentCard){ oldPayCard.remove(); }
        }
      }
    })();

    // Wire Pay (PayPal buttons if clientId present; otherwise fallback to link)
    (function(){
      const payLink = (window.bookingPaymentLinks[level]||{})[plan];
      const a = document.getElementById('payLink');
      const note = document.getElementById('payNote');
      const btnsWrap = document.getElementById('paypalButtons');

      const qs = new URLSearchParams(location.search);
      let cid = (window.paypalClientId||'').trim();
      const prices = window.bookingPrices || {};
      const currency = prices.currency || 'USD';
      let amount = prices[level] && prices[level][plan];
      // Quick test override: ?pp_test=1 forces sandbox demo client and $1.00 charge
      if (qs.get('pp_test') === '1'){ cid = 'sb'; amount = 1; }

      function renderButtons(){
        if (!cid || !amount) return false;
        const id = 'paypal-sdk';
        function setupButtons(){
          if (!window.paypal || !window.paypal.Buttons) return;
          btnsWrap.style.display = 'block';
          a.style.display = 'none';
          note.style.display = 'none';
          btnsWrap.innerHTML = '';
          const resultEl = document.getElementById('payResult');
          window.paypal.Buttons({
            style: { layout: 'horizontal', color: 'gold', shape: 'pill', label: 'pay' },
            createOrder: function(data, actions){
              return actions.order.create({
                purchase_units: [{ amount: { currency_code: currency, value: amount.toFixed(2) }, description: level + ' / ' + plan }]
              });
            },
            onApprove: function(data, actions){
              return actions.order.capture().then(function(details){
                // Show simple confirmation with order ID and payer name if available
                try {
                  const payer = details.payer && (details.payer.name?.given_name || details.payer.name?.surname) ?
                    (details.payer.name.given_name + ' ' + (details.payer.name.surname||'')).trim() : '';
                  const orderId = details.id || data.orderID || '';
                  const msg = `Payment received${payer? ' — ' + payer : ''}. Order ID: ${orderId}. We will review your requested time and send a confirmation email shortly.`;
                  if (resultEl){ resultEl.textContent = msg; resultEl.style.display = 'block'; }
                } catch(_){}
                // After capture, scroll to Step 2
                document.getElementById('schedulerEmbed')?.scrollIntoView({behavior:'smooth', block:'start'});
              });
            },
            onError: function(err){
              if (resultEl){ resultEl.textContent = 'There was an error with PayPal. Please try again.'; resultEl.style.display = 'block'; }
            },
            onCancel: function(){
              if (resultEl){ resultEl.textContent = 'Payment cancelled before completion.'; resultEl.style.display = 'block'; }
            }
          }).render('#paypalButtons');
        }
        if (!document.getElementById(id)){
          const s = document.createElement('script');
          s.id = id;
          s.src = 'https://www.paypal.com/sdk/js?components=buttons&client-id=' + encodeURIComponent(cid) + '&currency=' + encodeURIComponent(currency);
          s.onload = setupButtons;
          document.head.appendChild(s);
        } else {
          setupButtons();
        }
        return true;
      }

      if (!renderButtons()){
        if (payLink && payLink !== '#'){ a.href = payLink; note.style.display = 'none'; }
        else { a.href = '#'; note.style.display = 'block'; }
      }
    })();

    // Wire scheduler: supports Calendly (script embed) and generic iframe links.
    (function(){
      const qs = new URLSearchParams(location.search);
      const override = qs.get('sched');
      let baseUrl = override || ((window.bookingSchedulerLinks[level]||{})[plan]);
      const wrap = document.getElementById('schedulerEmbed');
      const note = document.getElementById('schedNote');
      const nameInput = document.getElementById('prefillName');
      const emailInput = document.getElementById('prefillEmail');
      const applyBtn = document.getElementById('applyPrefill');

      function ensureCalendlyScript(){
        if (document.getElementById('calendly-widget-js')) return;
        const s = document.createElement('script');
        s.id = 'calendly-widget-js';
        s.src = 'https://assets.calendly.com/assets/external/widget.js';
        s.async = true;
        document.head.appendChild(s);
      }

      function buildUrl(u){
        if (!u) return u;
        try{
          const url = new URL(u, location.origin);
          const name = (nameInput && nameInput.value || '').trim();
          const email = (emailInput && emailInput.value || '').trim();
          if (/cal\.com/i.test(url.hostname)){
            // Cal.com supports embed=true and basic prefill for name/email
            url.searchParams.set('embed', 'true');
            if (name) url.searchParams.set('name', name);
            if (email) url.searchParams.set('email', email);
          } else if (/calendly\.com/i.test(url.hostname)){
            if (name) url.searchParams.set('name', name);
            if (email) url.searchParams.set('email', email);
          }
          return url.toString();
        } catch { return u; }
      }

      function setCalendly(u){
        const finalUrl = buildUrl(u);
        wrap.innerHTML = '<div class="calendly-inline-widget" data-url="'+finalUrl.replace(/&/g,'&amp;')+'" style="min-width:320px;height:700px;"></div>';
        ensureCalendlyScript();
      }

      function setIframe(u){
        const finalUrl = buildUrl(u);
        const i = document.createElement('iframe');
        i.title = 'Scheduler';
        i.style.cssText = 'width:100%;height:700px;border:0;border-radius:8px;background:#fff';
        i.src = finalUrl;
        wrap.innerHTML = '';
        wrap.appendChild(i);
      }

      function readyForCalendar(){
        const name = (nameInput && nameInput.value || '').trim();
        const email = (emailInput && emailInput.value || '').trim();
        const okEmail = /.+@.+\..+/.test(email);
        return name.length > 1 && okEmail;
      }

      function render(force){
        // Gate calendar until name/email are provided (both flows)
        if (!force && !readyForCalendar()){
          wrap.innerHTML = '';
          note.textContent = 'Enter your name and email, then click "Apply to calendar".';
          note.style.display = 'block';
          return;
        }
        const url = baseUrl;
        if (url && url !== '#'){
          note.style.display = 'none';
          if (/calendly\.com/i.test(url)) setCalendly(url);
          else if (/cal\.com/i.test(url)) setIframe(url);
          else setIframe(url);
        } else {
          wrap.innerHTML = '';
          note.style.display = 'block';
        }
      }

      // Initial: don’t render until user applies (gated)
      render(false);

      // Apply prefill to show calendar
      if (applyBtn) applyBtn.addEventListener('click', ()=>render(true));
    })();
  </script>
  <script src="script.js"></script>
</body>
</html>
